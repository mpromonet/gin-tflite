<!DOCTYPE html>
<html lang="en">

<head>
  <title>tflite</title>
</head>

<body>
  <div id="container">
  </div>
</body>
<script>
  function draw(context, data) {
    if (data) {
      data.forEach(item => {
        context.fillText(item.ClassName, item.Box.Min.X, item.Box.Min.Y);
        context.rect(item.Box.Min.X, item.Box.Min.Y, (item.Box.Max.X - item.Box.Min.X), (item.Box.Max.Y - item.Box.Min.Y))
        context.stroke()
      })
    }
  }

  function invoke(output, context, input, url, blob, refresh) {
    fetch(url, {
      method: 'POST',
      body: blob
    })
      .then(r => r.json())
      .then(data => draw(context, data))
      .catch((err) => console.log(err))
      .finally(() => {
        if (refresh) {
          window.requestAnimationFrame(() => process(output, input, url, refresh))
        }
      })
  }

  function process(output, input, url, refresh) {
    output.width = input.width || input.videoWidth;
    output.height = input.height || input.videoHeight;

    var context = output.getContext('2d');
    context.drawImage(input, 0, 0);
    context.strokeStyle = 'rgb(0,255,0)'
    context.fillStyle = 'rgb(0,255,0)'
    context.lineWidth = 2;
    context.font = '20px serif';

    var dataurl = output.toDataURL("image/jpeg");
    fetch(dataurl)
      .then(r => r.blob())
      .then(blob => invoke(output, context, input, url, blob, refresh))
  }

  function loadFile(output, event, url) {
    var file = event.target.files[0]
    if (file.type.startsWith('image/')) {
      var reader = new FileReader()
      reader.onload = () => {
        var img = new Image()
        img.src = reader.result
        img.onload = () => process(output, img, url)
      }
      reader.readAsDataURL(file);
    } else if (file.type.startsWith('video/')) {
      var video = document.createElement('video')
      video.autoplay = true
      video.src = window.URL.createObjectURL(file)
      video.addEventListener('loadeddata', (event) => {
        window.requestAnimationFrame(() => process(output, video, url, true))
      });
    }
  }

  fetch("/models")
    .then(r => r.json())
    .then(r => {
        r.forEach(m => {
          var div = document.createElement("div")
          var input = document.createElement("input")
          var output = document.createElement("canvas")

          input.type = "file"
          input.accept = "image/*,video/*"
          input.onchange = function (event) { loadFile(output, event, `/invoke/${m}`) }
          output.id = "output" + m
          output.width = 0
          output.height = 0

          div.appendChild(document.createTextNode(m))
          div.appendChild(document.createElement('br'))
          div.appendChild(input)
          div.appendChild(document.createElement('br'))
          div.appendChild(output)
          document.getElementById("container").appendChild(div)
        }) 
      })
</script>

</html>